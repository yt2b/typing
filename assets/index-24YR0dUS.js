(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();var d=(n=>(n[n.Select=0]="Select",n[n.Decision=1]="Decision",n[n.Start=2]="Start",n[n.Typing=3]="Typing",n[n.MissTyping=4]="MissTyping",n[n.Completed=5]="Completed",n))(d||{});class B{inputs;constructor(){this.inputs=[]}setText(t){}getKey(){return this.inputs.shift()}setKey(t){this.inputs.push(t)}}class m{static State={Wait:0,Type:1};state=m.State.Wait;inputs;accuracy;prevTime;aveWaitTime;waitTime;aveStartTime;startTime;states;constructor(t,e,s){this.inputs=[],this.accuracy=t,this.prevTime=0,this.aveWaitTime=60*1e3/e,this.waitTime=this.aveWaitTime,this.aveStartTime=s,this.startTime=this.aveStartTime,this.states={[m.State.Wait]:this.wait.bind(this),[m.State.Type]:this.type.bind(this)}}setText(t){this.inputs=t.split(""),this.state=m.State.Wait,this.prevTime=new Date().getTime(),this.startTime=300+this.aveStartTime*(Math.random()*.8+.6),this.waitTime=this.aveWaitTime*(Math.random()*.3+.7)}getKey(){const t=new Date().getTime();return this.states[this.state](t)}wait(t){t-this.prevTime>this.startTime&&(this.state=m.State.Type)}type(t){if(t-this.prevTime>this.waitTime){if(this.prevTime=t,this.waitTime=this.aveWaitTime*(Math.random()*.3+.7),Math.random()<this.accuracy)return this.inputs.shift();this.waitTime*=1.4}}}class P{current;isEnd;history;constructor(t){this.current=t,this.isEnd=!1,this.history=[]}contains(t){return this.current.find(t)!==void 0}step(t){const e=this.current.find(t);e!==void 0&&(this.current=e,this.isEnd=e.children===void 0,this.history.push(t))}getCompletion(){const t=this.history.join(""),e=this.current.children,s=e===void 0?"":e[0].getCompletion();return t+s}}class N{acceptable=!1;accept(t,e){this.acceptable&&t.charas[t.idx+1].node.children?.map(a=>a.char)?.find(a=>a==e)&&(this.acceptable=!1,t.next());const s=t.step(e);if(s==g.Accept){const i=t.searcher.history,a=i.length==1&&i[0]=="n",r=t.idx,h=this.validate(t.charas[r],t.charas[r+1]);this.acceptable=a&&h}return s}getCompletion(t,e){return e===void 0||!this.validate(t,e)?t.node.getCompletion():"n"}getCurrentCompletion(t,e){return e===void 0||/[あ-おな-のやゆよん]/.test(e.value)?t.getCompletion():t.history.length==0||t.history.length==1&&t.history[0]=="n"?"n":t.getCompletion()}validate(t,e){return t.value=="ん"&&e!==void 0?!/[あ-おな-のやゆよん]/.test(e.value):!1}}class q{accept(t,e){if(t.step(e)==g.Accept)return g.Accept;const s=t.charas[t.idx+1];if(s===void 0||/[あ-おな-のんーa-z0-9!?,.[\]]/.test(s.value))return g.Reject;const i=t.searcher.history.length,a=s.getConsonants();if(i<=1&&a.find(r=>r==e)){t.history+=e,t.next(),i==1&&t.step(e);const r=t.charas[t.idx],h=r.getConsonants();if(h.length>1){const l=h.findIndex(F=>F==e),w=r.node.children?.splice(l,1);r.node.children=w}return t.updateCompletion(),g.Accept}return g.Reject}getCompletion(t,e){return e===void 0||/[あ-おな-のんーa-z0-9!?,.[\]]/.test(e.value)?t.node.getCompletion():e.getConsonants()[0]}getCurrentCompletion(t,e){return e===void 0||/[あ-おな-のんーa-z0-9!?,.[\]]/.test(e.value)?t.getCompletion():t.history.length==0?e.getConsonants()[0]:t.getCompletion()}}var g=(n=>(n[n.Accept=0]="Accept",n[n.Reject=1]="Reject",n))(g||{});class j{idx=0;count=0;history="";completion="";end=!1;charas;searcher;specialRuleHandlers;constructor(t){this.charas=t,this.searcher=new P(this.charas[0].node),this.specialRuleHandlers={ん:new N,っ:new q},this.updateCompletion()}accept(t){const e=this.charas[this.idx],s=this.specialRuleHandlers[e.value];return s===void 0?this.step(t):s.accept(this,t)}step(t){return this.searcher.contains(t)?(this.searcher.step(t),this.count+=1,this.history+=t,this.searcher.isEnd?this.charas[this.idx+1]===void 0?this.end=!0:this.next():this.updateCompletion(),0):1}next(){this.idx+=1,this.count=0,this.searcher=new P(this.charas[this.idx].node),this.updateCompletion()}updateCompletion(){const t=this.history.substring(0,this.history.length-this.count),e=this.specialRuleHandlers[this.charas[this.idx].value],s=e===void 0?this.searcher.getCompletion():e.getCurrentCompletion(this.searcher,this.charas[this.idx+1]),i=this.charas.slice(this.idx+1).map((a,r)=>{const h=this.specialRuleHandlers[a.value];return h===void 0?a.node.getCompletion():h.getCompletion(a,this.charas[this.idx+r+2])}).reduce((a,r)=>a+r,"");this.completion=t+s+i}}class ${value;node;constructor(t,e){this.value=t,this.node=e}getConsonants(){return/[あ-おーa-z0-9!?,.[\]]/.test(this.value)||this.node.children===void 0?[]:this.node.children.map(t=>t.char)}}const H=n=>{const t=new W("",[]);for(const e of n){let s=t;Array.from(e).forEach(i=>{const a=s.find(i);if(a===void 0){const r=new W(i);s.push(r),s=r}else s=a})}return t};class W{char;children;constructor(t,e){this.char=t,this.children=e}push(t){this.children===void 0&&(this.children=[]),this.children.push(t)}find(t){return this.children?.find(e=>e.char===t)}getCompletion(){const t=this.children;return this.char+(t===void 0?"":t[0].getCompletion())}}class Y{patterns;constructor(t){this.patterns=t}create(t){const e=this.split(t),s=[];return e.forEach(i=>{const a=H(this.patterns[i]);s.push(new $(i,a))}),new j(s)}split(t){const e=[];let s="";for(let i=0;i<t.length-1;i++)s=s+t.charAt(i),s+t.charAt(i+1)in this.patterns||(e.push(s),s="");return e.push(s+t.charAt(t.length-1)),e}}const A={あ:["a"],い:["i","yi"],う:["u","wu"],え:["e"],お:["o"],か:["ka","ca"],き:["ki"],く:["ku","cu"],け:["ke"],こ:["ko","co"],さ:["sa"],し:["si","shi","ci"],す:["su"],せ:["se","ce"],そ:["so"],た:["ta"],ち:["ti","chi"],つ:["tu","tsu"],て:["te"],と:["to"],な:["na"],に:["ni"],ぬ:["nu"],ね:["ne"],の:["no"],は:["ha"],ひ:["hi"],ふ:["hu","fu"],へ:["he"],ほ:["ho"],ま:["ma"],み:["mi"],む:["mu"],め:["me"],も:["mo"],や:["ya"],ゆ:["yu"],よ:["yo"],ら:["ra"],り:["ri"],る:["ru"],れ:["re"],ろ:["ro"],わ:["wa"],を:["wo"],ん:["nn","xn"],ゔ:["vu"],が:["ga"],ぎ:["gi"],ぐ:["gu"],げ:["ge"],ご:["go"],ざ:["za"],じ:["zi","ji"],ず:["zu"],ぜ:["ze"],ぞ:["zo"],だ:["da"],ぢ:["di"],づ:["du"],で:["de"],ど:["do"],ば:["ba"],び:["bi"],ぶ:["bu"],べ:["be"],ぼ:["bo"],ぱ:["pa"],ぴ:["pi"],ぷ:["pu"],ぺ:["pe"],ぽ:["po"],ぁ:["la","xa"],ぃ:["li","lyi","xi"],ぅ:["lu","xu"],ぇ:["le","lye","xo"],ぉ:["lo","xo"],ゃ:["lya","xya"],ゅ:["lyu","xyu"],ょ:["lyo","xyo"],っ:["ltu","xtu","ltsu","xtsu"],ー:["-"],a:["a"],b:["b"],c:["c"],d:["d"],e:["e"],f:["f"],g:["g"],h:["h"],i:["i"],j:["j"],k:["k"],l:["l"],m:["m"],n:["n"],o:["o"],p:["p"],q:["q"],r:["r"],s:["s"],t:["t"],u:["u"],v:["v"],w:["w"],x:["x"],y:["y"],z:["z"],0:["0"],1:["1"],2:["2"],3:["3"],4:["4"],5:["5"],6:["6"],7:["7"],8:["8"],9:["9"],"!":["!"],"?":["?"]," ":[" "],"[":["["],"]":["]"],",":[","],".":["."]},K={いぇ:["ye"],きゃ:["kya"],きぃ:["kyi"],きゅ:["kyu"],きぇ:["kye"],きょ:["kyo"],くぁ:["qa","kwa"],くぃ:["qi","kwi"],くぇ:["qe","kwe"],くぉ:["qo","kwo"],しゃ:["sya","sha"],しぃ:["syi","shi"],しゅ:["syu","shu"],しぇ:["sye","she"],しょ:["syo","sho"],ちゃ:["tya","cya","cha"],ちぃ:["tyi","cyi"],ちゅ:["tyu","cyu","chu"],ちぇ:["tye","cye","che"],ちょ:["tyo","cyo","cho"],つぁ:["tsa"],つぃ:["tsi"],つぇ:["tse"],つぉ:["tso"],てぃ:["thi"],とぅ:["twu"],にゃ:["nya"],にぃ:["nyi"],にゅ:["nyu"],にぇ:["nye"],にょ:["nyo"],ひゃ:["hya"],ひぃ:["hyi"],ひゅ:["hyu"],ひぇ:["hye"],ひょ:["hyo"],みゃ:["mya"],みぃ:["myi"],みゅ:["myu"],みぇ:["mye"],みょ:["myo"],りゃ:["rya"],りぃ:["ryi"],りゅ:["ryu"],りぇ:["rye"],りょ:["ryo"],ふぁ:["fa"],ふぃ:["fi"],ふぇ:["fe"],ふぉ:["fo"],ぎゃ:["gya"],ぎぃ:["gyi"],ぎゅ:["gyu"],ぎぇ:["gye"],ぎょ:["gyo"],ぐぁ:["gwa"],じゃ:["ja","zya"],じぃ:["zyi"],じゅ:["ju","zyu"],じぇ:["je","zye"],じょ:["jo","zyo"],ぢゃ:["dya"],ぢぃ:["dyi"],ぢゅ:["dyu"],ぢぇ:["dye"],ぢょ:["dyo"],でぃ:["dhi"],でゅ:["dhu"],どぅ:["dwu"],びゃ:["bya"],びぃ:["byi"],びゅ:["byu"],びぇ:["bye"],びょ:["byo"],ぴゃ:["pya"],ぴぃ:["pyi"],ぴゅ:["pyu"],ぴぇ:["pye"],ぴょ:["pyo"],うぁ:["wha"],うぃ:["wi","whi"],うぇ:["we","whe"],うぉ:["who"],ゔぁ:["va"],ゔぃ:["vi"],ゔぇ:["ve"],ゔぉ:["vo"],ゔゅ:["vyu"]},U=n=>{if(n.length!=2)return[];const t=A[n.charAt(0)],e=A[n.charAt(1)];return t.flatMap(s=>e.map(i=>s+i))},G=()=>{const n=Object.entries(K).map(([t,e])=>[t,e.concat(U(t))]);return{...A,...Object.fromEntries(n)}};class X{player;acceptor;score=0;countTotalTyping=0;countMissTyping=0;constructor(t,e){this.player=t,this.acceptor=e,this.player.setText(e.completion)}setAcceptor(t){this.acceptor=t,this.player.setText(t.completion)}update(){const t=this.player.getKey();if(t!==void 0)return this.countTotalTyping++,this.acceptor.accept(t)==g.Accept?d.Typing:(this.countMissTyping++,d.MissTyping)}isEnd(){return this.acceptor.end}}class V{words;currentWord;nextWord;factory;typists=[];constructor(t,e,s){this.words=t,this.currentWord=this.words[Math.floor(Math.random()*this.words.length)],this.nextWord=this.words[Math.floor(Math.random()*this.words.length)],this.factory=e,this.setPlayers(s)}setPlayers(t){this.typists=t.map(e=>new X(e,this.factory.create(this.currentWord.inputText)))}setNextWord(){this.currentWord=this.nextWord,this.nextWord=this.words[Math.floor(Math.random()*this.words.length)];for(const t of this.typists)t.setAcceptor(this.factory.create(this.currentWord.inputText))}update(){const t=[];this.typists.forEach((s,i)=>{const a=s.update();a!==void 0&&t.push({type:a,payload:{idx:i}})});const e=this.typists.findIndex(s=>s.isEnd());return e!=-1&&(this.typists[e].score+=1,this.setNextWord(),t.push({type:d.Completed,payload:{idx:e,isPerfect:!1}})),t}}let p=class f{static State={FadeIn:0,Select:1,FadeOut:2};static Battle={Win:0,Lose:1,Draw:2};static FADE_FRAMES=10;states={[f.State.FadeIn]:this.runFadeIn.bind(this),[f.State.Select]:this.runSelect.bind(this),[f.State.FadeOut]:this.runFadeOut.bind(this)};state=f.State.FadeIn;count=0;statistics;constructor(){}initialize(t){this.statistics=t,this.state=f.State.FadeIn,this.count=0}update(t){return this.count++,this.states[this.state](t)}runFadeIn(t){return this.count>=f.FADE_FRAMES&&(this.state=f.State.Select,this.count=0),{sceneType:c.Result}}runSelect(t){const e=[];return t==" "&&(this.state=f.State.FadeOut,this.count=0,e.push({type:d.Decision})),{sceneType:c.Result,events:e}}runFadeOut(t){return this.count>=f.FADE_FRAMES?{sceneType:c.Title}:{sceneType:c.Result}}},T=class u{static State={FadeIn:0,Wait:1,Typing:2,FadeOut:3};static FADE_FRAMES=10;states={[u.State.FadeIn]:this.runFadeIn.bind(this),[u.State.Wait]:this.runWait.bind(this),[u.State.Typing]:this.runTyping.bind(this),[u.State.FadeOut]:this.runFadeOut.bind(this)};state=u.State.FadeIn;count=0;timeLimit=0;startTime=0;currentTime=0;human;manager;constructor(t){const e=new Y(G());this.human=new B,this.manager=new V(t,e,[this.human,new m(.5,100,2e3)])}initialize(t){if(this.state=u.State.FadeIn,this.count=0,t!==void 0){const{timeLimit:e,accuracy:s,kpm:i,aveStartTime:a}=t;this.timeLimit=e;const r=new m(s,i,a);this.manager.setPlayers([this.human,r])}this.manager.setNextWord()}update(t){return this.count++,this.states[this.state](t)}runFadeIn(t){return this.count>=u.FADE_FRAMES&&(this.state=u.State.Wait,this.count=0),{sceneType:c.Main,events:[]}}runWait(t){return t==" "?(this.state=u.State.Typing,this.count=0,this.startTime=new Date().getTime(),{sceneType:c.Main,events:[{type:d.Start}]}):{sceneType:c.Main,events:[]}}runTyping(t){t!==void 0&&t.length==1&&this.human.setKey(t);const e=this.manager.update();return this.currentTime=new Date().getTime(),this.currentTime-this.startTime>=this.timeLimit&&(this.state=u.State.FadeOut,this.count=0),{sceneType:c.Main,events:e}}runFadeOut(t){if(this.count>=u.FADE_FRAMES){let e=p.Battle.Draw;const s=this.manager.typists[0],i=this.manager.typists[1];s.score>i.score?e=p.Battle.Win:s.score<i.score&&(e=p.Battle.Lose);const a={timeLimit:this.timeLimit,battle:e,score:s.score,countTotalTyping:s.countTotalTyping,countMissTyping:s.countMissTyping};return{sceneType:c.Result,events:[],param:a}}return{sceneType:c.Main}}};var M=(n=>(n.Up="<up>",n.Down="<down>",n.Left="<left>",n.Right="<right>",n.Enter="<enter>",n))(M||{});class J{queue;constructor(){this.queue=[],window.addEventListener("keydown",t=>{switch(t.key){case"ArrowUp":this.queue.push("<up>");break;case"ArrowDown":this.queue.push("<down>");break;case"ArrowLeft":this.queue.push("<left>");break;case"ArrowRight":this.queue.push("<right>");break;case"Enter":this.queue.push("<enter>");break;default:t.key.length==1&&this.queue.push(t.key)}})}getKey(){return this.queue.shift()}}let S=class x{static State={FadeIn:0,Select:1,FadeOut:2};static FADE_FRAMES=10;states={[x.State.FadeIn]:this.runFadeIn.bind(this),[x.State.Select]:this.runSelect.bind(this),[x.State.FadeOut]:this.runFadeOut.bind(this)};difficulties;idx=0;state=x.State.Select;count=0;constructor(){this.difficulties=[{name:"初級",param:{timeLimit:3e4,accuracy:.8,kpm:180,aveStartTime:1500}},{name:"中級",param:{timeLimit:45e3,accuracy:.9,kpm:400,aveStartTime:1e3}},{name:"上級",param:{timeLimit:6e4,accuracy:.95,kpm:580,aveStartTime:1e3}}]}initialize(t){this.idx=0,this.state=x.State.FadeIn,this.count=0}update(t){return this.count++,this.states[this.state](t)}runFadeIn(t){return this.count>=x.FADE_FRAMES&&(this.state=x.State.Select,this.count=0),{sceneType:c.Title}}runSelect(t){const e=[];switch(t){case M.Up:this.idx-=1,this.idx<0&&(this.idx=this.difficulties.length-1),e.push({type:d.Select});break;case M.Down:this.idx+=1,this.idx>=this.difficulties.length&&(this.idx=0),e.push({type:d.Select});break;case" ":this.state=x.State.FadeOut,this.count=0,e.push({type:d.Decision});break}return{sceneType:c.Title,events:e}}runFadeOut(t){if(this.count>=x.FADE_FRAMES){const e=this.difficulties[this.idx].param;return{sceneType:c.Main,param:e}}return{sceneType:c.Title}}};var c=(n=>(n[n.Title=0]="Title",n[n.Main=1]="Main",n[n.Result=2]="Result",n))(c||{});class Q{sceneType;nextSceneType;param;events=[];scenes;constructor(t){this.sceneType=this.nextSceneType=0,this.scenes={0:new S,1:new T(t),2:new p}}update(t){this.sceneType!=this.nextSceneType&&this.scenes[this.nextSceneType].initialize(this.param),this.sceneType=this.nextSceneType;const{sceneType:e,events:s,param:i}=this.getScene().update(t);this.nextSceneType=e,this.param=i,s!==void 0&&(this.events=this.events.concat(s))}getEvents(){const t=this.events;return this.events=[],t}getScene(){return this.scenes[this.sceneType]}}class o{x;y;constructor(t,e){this.x=t,this.y=e}}class C{ctx;strokeColor;fillColor;pos;size;strokeWidth;constructor(t,e,s,i,a,r){this.ctx=t,this.strokeColor=e,this.fillColor=s,this.pos=i,this.size=a,this.strokeWidth=r}draw(){this.ctx.strokeStyle=this.strokeColor,this.ctx.lineWidth=this.strokeWidth,this.ctx.strokeRect(this.pos.x,this.pos.y,this.size.x,this.size.y),this.ctx.fillStyle=this.fillColor,this.ctx.fillRect(this.pos.x,this.pos.y,this.size.x,this.size.y)}}class E{ctx;inputText;strokeColor;constructor(t,e,s){this.ctx=t,this.inputText=e,this.strokeColor=s}drawRect(t){const e=this.inputText.text.getSize(t),s=20,i=30,a=new o((this.inputText.width-e.x)/2-s,this.inputText.pos.y-e.y-i),r=new o(e.x+s*2,e.y+i*2);new C(this.ctx,this.strokeColor,"#444444",a,r,12).draw()}draw(t){this.drawRect(t.completion),this.inputText.draw(t)}}class D{name;color;scoreText;nameText;scorePos;namePos;rect;constructor(t,e,s,i,a,r){this.name=e,this.color=s,this.nameText=a,this.scoreText=i,this.scorePos=r;const h=this.scoreText.getSize("000"),l=this.nameText.getSize(this.name),w=this.scorePos.x+(h.x-l.x)/2,F=this.scorePos.y-h.y-10;this.namePos=new o(w,F);const z=40,k=30,R=h.y+l.y,I=new o(this.scorePos.x-z,this.scorePos.y-R-k),L=new o(h.x+z*2,R+k*2);this.rect=new C(t,s,"#000000c0",I,L,12)}draw(t){this.rect.draw(),this.scoreText.draw(t.toString().padStart(3,"0"),this.scorePos),this.nameText.draw(this.name,this.namePos)}}class Z{ctx;pos;text;color;count;alpha;constructor(t,e,s,i){this.ctx=t,this.pos=e,this.text=s,this.color=i,this.count=60,this.alpha=1}isAlive(){return this.count>0}draw(){this.ctx.font=this.text.font,this.ctx.strokeStyle=this.color,this.ctx.lineWidth=4,this.ctx.globalAlpha=this.alpha,this.text.draw("+1",this.pos),this.ctx.strokeText("+1",this.pos.x,this.pos.y),this.ctx.globalAlpha=1,this.pos.y-=.5,this.count-=1,this.count<=15&&(this.alpha=this.count/15)}}class y{ctx;color;font;constructor(t,e,s){this.ctx=t,this.color=e,this.font=s}setStyle(){this.ctx.fillStyle=this.color,this.ctx.font=this.font}getSize(t){this.setStyle();const e=this.ctx.measureText(t),s=e.width,i=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent;return new o(s,i)}draw(t,e){this.setStyle(),this.ctx.fillText(t,e.x,e.y)}}class v{width;text;pos;constructor(t,e,s){this.width=t,this.text=e,this.pos=new o(0,s)}draw(t){this.pos.x=(this.width-this.text.getSize(t).x)/2,this.text.draw(t,this.pos)}}class O{ctx;width;text;pos;constructor(t,e,s,i){this.ctx=t,this.width=e,this.text=s,this.pos=new o(0,i)}draw(t){const e=t.history,s=t.completion;this.pos.x=(this.width-this.text.getSize(s).x)/2,this.ctx.globalAlpha=.15,this.text.draw(e,this.pos),this.ctx.globalAlpha=1;const i=s.substring(e.length);this.pos.x+=this.text.getSize(e).x,this.text.draw(i,this.pos)}}const b=(n,t)=>{n.globalAlpha=t,n.fillStyle="#000000",n.fillRect(0,0,n.canvas.width,n.canvas.height),n.globalAlpha=1};class _{ctx;width;height;currentWord;acceptorTexts;scoreBoards;effectText;effects;states;constructor(t,e,s){this.ctx=t,this.width=e,this.height=s,this.currentWord=new v(this.width,new y(this.ctx,"#000000","bold 36px 'Meiryo', sans-serif"),80);const i=new y(this.ctx,"#ffffff","bold 28px 'Yu Gothic', 'Meiryo', sans-serif"),a="#ff880060",r="#32cd3260";this.acceptorTexts=[new E(this.ctx,new O(this.ctx,this.width,i,190),a),new E(this.ctx,new O(this.ctx,this.width,i,320),r)];const h=new y(this.ctx,"#ffffff","bold 24px 'Meiryo', sans-serif"),l=new y(this.ctx,"#ffffff","50px 'Meiryo', sans-serif");this.scoreBoards=[new D(this.ctx,"YOU",a,l,h,new o(228,480)),new D(this.ctx,"NPC",r,l,h,new o(488,480))],this.effectText=new y(this.ctx,"#ffffff","bold 60px 'Meiryo', sans-serif"),this.effects=[],this.states={[T.State.FadeIn]:this.renderFadeIn.bind(this),[T.State.Wait]:this.renderWait.bind(this),[T.State.Typing]:this.renderTyping.bind(this),[T.State.FadeOut]:this.renderFadeOut.bind(this)}}initialize(){this.effects=[]}handle_events(t){t.forEach(e=>{switch(e.type){case d.Completed:{const{idx:s}=e.payload,i=this.scoreBoards[s],a=i.scorePos.x+i.scoreText.getSize("000").x,r=i.scorePos.y,h=i.color.substring(0,i.color.length-2);this.effects.push(new Z(this.ctx,new o(a,r),this.effectText,h))}break}})}render(t){const e=t;this.states[e.state](e)}renderFadeIn(t){this.renderWait(t),b(this.ctx,1-t.count/T.FADE_FRAMES)}renderWait(t){this.ctx.fillStyle="#ff8c00",this.ctx.fillRect(0,0,this.width,20),this.currentWord.draw("<Space>を押して開始"),t.manager.typists.forEach((e,s)=>{this.acceptorTexts[s].drawRect(e.acceptor.completion),this.scoreBoards[s].draw(e.score)})}renderTyping(t){const e=t.currentTime-t.startTime,s=this.width*(t.timeLimit-e)/t.timeLimit;this.ctx.fillStyle="#ff8c00",this.ctx.fillRect(0,0,s,20),this.currentWord.draw(t.manager.currentWord.displayText),t.manager.typists.forEach((i,a)=>{this.acceptorTexts[a].draw(i.acceptor),this.scoreBoards[a].draw(i.score)}),this.effects=this.effects.filter(i=>(i.draw(),i.isAlive()))}renderFadeOut(t){this.renderTyping(t),b(this.ctx,t.count/T.FADE_FRAMES)}}class tt{ctx;largeText;smallText;pos;size;isSelected;difficultyTextPos;timeLimitTextPos;speedTextPos;accuracyTextPos;constructor(t,e,s,i,a){this.ctx=t,this.largeText=s,this.smallText=i,this.pos=a,this.size=e,this.isSelected=!1;const r=this.largeText.getSize("A").y,h=a.y+(this.size.y+r)/2;this.difficultyTextPos=new o(a.x+30,h);const l=this.smallText.getSize("A").y,w=this.pos.y+(this.size.y+l)/2;this.timeLimitTextPos=new o(this.difficultyTextPos.x+170,w-l*1.5),this.speedTextPos=new o(this.difficultyTextPos.x+170,w),this.accuracyTextPos=new o(this.difficultyTextPos.x+170,w+l*1.5)}render(t){const e=this.isSelected?"#ff8800a0":"#442200";new C(this.ctx,e,"#444444",this.pos,this.size,12).draw(),this.ctx.globalAlpha=this.isSelected?1:.05,this.largeText.draw(t.name,this.difficultyTextPos),this.smallText.draw(`制限時間: ${t.param.timeLimit/1e3}秒`,this.timeLimitTextPos),this.smallText.draw(`NPCの速度: 最大${(t.param.kpm/60).toFixed(1)}文字/秒`,this.speedTextPos),this.smallText.draw(`NPCの正確性: ${t.param.accuracy*100}%`,this.accuracyTextPos),this.ctx.globalAlpha=1}}class et{ctx;width;height;displayText;description;operation;boards;states={[S.State.FadeIn]:this.renderFadeIn.bind(this),[S.State.Select]:this.renderSelect.bind(this),[S.State.FadeOut]:this.renderFadeOut.bind(this)};constructor(t,e,s){this.ctx=t,this.width=e,this.height=s,this.displayText=new v(this.width,new y(this.ctx,"#000000","bold 80px 'Meiryo', sans-serif"),60);const i=new y(this.ctx,"#000000","bold 25px 'Meiryo', sans-serif");this.description=new v(this.width,i,110),this.operation=new v(this.width,i,s-10);const a=new y(this.ctx,"#ffffff","bold 70px 'Meiryo', sans-serif"),r=new y(this.ctx,"#ffffff","bold 25px 'Meiryo', sans-serif"),h=new o(550,110);this.boards=[];for(let l=0;l<3;l++){const w=new o((e-h.x)/2,150+(h.y+20)*l);this.boards.push(new tt(this.ctx,h,a,r,w))}}initialize(){}handle_events(t){}render(t){const e=t;this.states[e.state](e)}renderFadeIn(t){this.renderSelect(t),b(this.ctx,1-t.count/S.FADE_FRAMES)}renderSelect(t){this.displayText.draw("VS Typing"),this.description.draw("表示された文章をNPCよりも速く入力してください"),this.operation.draw("↑↓:選択  <Space>:決定"),t.difficulties.forEach((e,s)=>{this.boards[s].isSelected=t.idx==s,this.boards[s].render(e)})}renderFadeOut(t){this.renderSelect(t),b(this.ctx,t.count/S.FADE_FRAMES)}}class st{states={[p.State.FadeIn]:this.renderFadeIn.bind(this),[p.State.Select]:this.renderSelect.bind(this),[p.State.FadeOut]:this.renderFadeOut.bind(this)};ctx;width;height;battle;statistics;operation;constructor(t,e,s){this.ctx=t,this.width=e,this.height=s,this.battle=new v(this.width,new y(this.ctx,"#000000","bold 48px 'Meiryo', sans-serif"),50);const i=new y(this.ctx,"#000000","bold 25px 'Meiryo', sans-serif");this.statistics=new y(this.ctx,"#000000","bold 36px 'Meiryo', sans-serif"),this.operation=new v(this.width,i,s-10)}initialize(){}handle_events(t){}render(t){const e=t;this.states[e.state](e)}renderFadeIn(t){this.renderSelect(t),b(this.ctx,1-t.count/p.FADE_FRAMES)}renderSelect(t){switch(this.ctx.fillStyle="#ffffff",t.statistics?.battle){case p.Battle.Win:this.battle.draw("You win!！");break;case p.Battle.Lose:this.battle.draw("You lose..");break;case p.Battle.Draw:this.battle.draw("Draw");break}this.statistics.draw("スコア",new o(160,150)),this.statistics.draw("総打鍵数",new o(160,210)),this.statistics.draw("ミス数",new o(160,270)),this.statistics.draw("入力速度",new o(160,330)),this.statistics.draw("正確性",new o(160,390));const e=t.statistics;if(e!==void 0){this.statistics.draw(`${e.score}`,new o(460,150)),this.statistics.draw(`${e.countTotalTyping}`,new o(460,210)),this.statistics.draw(`${e.countMissTyping}`,new o(460,270)),this.statistics.draw(`${(e.countTotalTyping/(e.timeLimit/1e3)).toFixed(1)}文字/秒`,new o(460,330));let s=100;e.countTotalTyping!=0&&(s=(e.countTotalTyping-e.countMissTyping)/e.countTotalTyping*100),this.statistics.draw(`${s.toFixed(0)}%`,new o(460,390))}this.operation.draw("<Space>:タイトルに戻る")}renderFadeOut(t){this.renderSelect(t),b(this.ctx,t.count/p.FADE_FRAMES)}}class it{canvas;ctx;width;height;scenes;prevSceneType;constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.width=parseFloat(getComputedStyle(this.canvas).width),this.height=parseFloat(getComputedStyle(this.canvas).height);const e=window.devicePixelRatio;this.canvas.width=this.width*e,this.canvas.height=this.height*e,this.ctx.scale(e,e),this.scenes={[c.Title]:new et(this.ctx,this.width,this.height),[c.Main]:new _(this.ctx,this.width,this.height),[c.Result]:new st(this.ctx,this.width,this.height)}}handle_events(t,e){this.scenes[t].handle_events(e)}render(t,e){this.ctx.fillStyle="#f8f8f8",this.ctx.fillRect(0,0,this.width,this.height),t!==this.prevSceneType&&(this.prevSceneType=t,this.scenes[t].initialize()),this.scenes[t].render(e)}}const nt=async()=>await at("words/words.json"),at=async n=>await(await fetch(n)).json();class rt{sources={};context;gainNode;constructor(){this.context=new AudioContext,this.gainNode=this.context.createGain(),this.gainNode.gain.value=.3}async load(){["select","decision","typing0","typing1","miss","complete"].forEach(async e=>{const i=await(await fetch(`audio/${e}.mp3`)).arrayBuffer(),a=await this.context.decodeAudioData(i);this.sources[e]=a})}play(t){const e=this.context.createBufferSource();e.buffer=this.sources[t],e.connect(this.gainNode).connect(this.context.destination),e.start(0)}handle_events(t){t.forEach(e=>{switch(e.type){case d.Select:this.play("select");break;case d.Decision:this.play("decision");break;case d.Start:this.play("decision");break;case d.Typing:{const{idx:s}=e.payload;this.play(`typing${s}`);break}case d.MissTyping:this.play("miss");break;case d.Completed:this.play("complete");break}})}}window.addEventListener("load",async()=>{const n=await nt(),t=new J,e=new Q(n),s=new it(document.getElementById("canvas")),i=new rt;await i.load();const a=r=>{e.update(t.getKey());const h=e.getEvents();s.handle_events(e.sceneType,h),s.render(e.sceneType,e.getScene()),i.handle_events(h),window.requestAnimationFrame(a)};window.requestAnimationFrame(a)});
